
<body>
<template id="brui-BeforeLoad" data-bridge-load-script="true">
  ##
  // https://www.iconfinder.com/icons/778138/cursor_direction_drag_move_icon#size=24
  // https://www.iconfinder.com/HazelDev
  
  var BridgeUi = window.BridgeUi = {};

  BridgeUi.toStyle = function(obj) {
    if (!obj) {
      return '';
    }
    var keys = Object.keys(obj);
    if (keys.length === 0) {
      return '';
    }

    return keys.map(function(name) {
      return name + ': ' + obj[name];
    }).join('; ') + ';';
  }

  BridgeUi.HtmlObj = {
      doc: document,
      head: document.head,
      body: document.body,
      query: function(selector) {return this.doc.querySelector(selector);},
      element: function(tagName){return this.doc.createElement(tagName);},
      id: function(id) {this.doc.getElementById(id);},
      tag: function(tagName, attrs) {
          attrs = attrs || [];
          var element = this.element(tagName);
          Object.keys(attrs).forEach(function(key) {
              //element.setAttribute(key, attrs[key]);
              element[key] = attrs[key];
          });
          return element;
      },
      event: function(obj, eventName, func) {
          obj.addEventListener(eventName, func);
      }
  }
  
  var iconSize = 20;
  var runIconSize = 40;

  BridgeUi.WindowStyle = {
    '.brui-WindowIcon': {
      'z-index': 10,
      position: 'absolute',
      cursor: 'pointer',
      width: iconSize + 'px',
      height: iconSize + 'px',
      opacity: 0.4,
      //border: '1px solid #c8ccd0',
      'background-color': 'rgba(255,255,255,0.8)'
    },

    '.brui-Window .brui-WindowIcon': {
      opacity: '0'
    },
    '.brui-Window:hover .brui-WindowIcon': {
      opacity: '0.4'
    },
    '.brui-Window:hover .brui-WindowIcon:hover': {
      opacity: '1'
    },

    '.brui-Window .brui-Window-Title': {
      height: iconSize + 'px',
      'text-align': 'center',
      'border-bottom': '1px solid rgba(0,0,0,0.3)',
      'box-shadow': '0px 3px 5px -3px #c8ccd0',
      
      'color': '#333',
      'font-family': 'Segoe UI Regular WestEuropean,Segoe UI,Tahoma,Arial,sans-serif',
      'font-size': '12px',
      'font-weight': '400'
    },
    
    '.brui-WindowCloser': {
      background: 'url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAABEklEQVRIS+1VyRGDMAy0gUlogl5owk+XQA/0oqdrogeenhwkYwYHYyzJJMMv/GCs3ZW0a6Q4+ZEn44s/ATvh3Yi01i9fBQCFEOLzjqFFNRtMksABAgC5J631JMS6y/g8S0CRhMqDrqVSqjTGPN23pDqs0IM4gLquH/HIUt1i7cul9Q2G3wknICyi5psi8Qvf1FlrKz+SuCs2aCm1IQhnApbAgWEkHDi65KhNNyrniJ2YnJywHWSMiAzjoRAhSZ4AoMRSjhIgVpzV/mTTvu+LYRjmFGJu6bruOo6j/SpolPIQMEdI0kUxAWXFVCeHLrscn7dtWzVNcw8vO/aqUEpdjDG3xfvs/4A6x+aA/WUxB04neAMaIYoZ/zJr8gAAAABJRU5ErkJggg==) center/80% no-repeat'
    },
    '.brui-WindowResize': {
      //background: 'url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAr0lEQVRIS8WWUQ6AIAxD4aCcjoNq+MDAWGcdI/qJpt26B5jT4Scf1k//GpRSrtZhrXUqBK1racAOuog0QOvtO81YNdgRlwUtBpHizUzN1hOLNqvJILryPvCnA21AzEBR5YuBRMwrLgv9RNGIorU/xnc0RR5xmiKvOEXRjrhqgM4dNnMJi3maekiiKPLGohUUhinqNgRTK0rqsLMis8ThPmBJehNfDNAPwM7VefzSvwETvugZx8YDUAAAAABJRU5ErkJggg==) center/80% no-repeat',
      // https://www.iconfinder.com/icons/103302/arrow_lowerright_sans_icon#size=128
      background: 'url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAADZklEQVR4Xu2d0WocQQwE118ef3o4YhPH8d2OpndnJHUt+MkSSF11Ah+YfTt4rBN4s96e5Q8EMJcAARDAPAHz9bkACGCegPn6XAAEME/AfH0uAAKYJ2C+PhcAAcwTMF+fC4AA5gmYr88FQADzBMzX5wIggHkC5utzARDAPAHz9bkACGCegPn6XAAEME/AfH0uAAKYJ2C+PhcAAcwTMF+fC4AA5gmYr88FQADzBGqv/34cx+Nn+uECTEe3vfEB/tdxaP/ijwDbOU4N8An/0SwxlJqnRqdJTeArfARQ0yzW/x0+AhQDqIz7E3wEUBIt1PsMPgIUgjg76iv4CDCbapG+M/gIUATkzJgj8BFgJtkCPaPwEaAAzOiIEfgIEE03eX0UPgIkBxoZbwY+AkQSTlw7Cx8BEkMdHU2BjwCjKSetU+EjQFKwI2NdAR8BRpJOWHMVfARICPdspCvhI8BZ2sl+fzV8BEgG+NU4d8BHgCIC3AUfAQoIcCd8BEguwN3wESCxACvgI0BSAVbBR4CEAqyEjwDJBFgNHwESCbADPgIkEWAXfARIIMBO+AiwWYDd8BFgowAZ4CPAJgGywEeADQJkgo8AiwXIBh8BFgqQET4CLBIgK3wEWCBAZvgIcLMA2eEjwI0CVICPADcJUAU+AtwgQCX4CHCxANXgI8CFAlSEjwAXCVAVPgJcIEBl+AggClAdPgIIAnSAjwCTAnSBjwATAnSCjwBBAbrBR4CAAB3hI8CgAF3hI8CAAJ3hI8CJAN3hI8ALARzgI8ATAVzgI8APAjjBR4BvArjBR4AvAjjCR4APAVzhI8DH69Mfb9F2faT3P0vNCRJ3/uR/xi8xlJo3CwD8PwAkhlLzRgGA/zd8iaHUvEkA4P8bvMRQat4gAPD/D11iKDUvFgD4PwcuMZSaFwoA/OdhSwyl5kUCAP910BJDqXmBAMA/D1liKDWfzyZVAH8sPomh1Dw231QV8MdjkxhKzeMzhiqBH4qr1zeBwI/Bb/VVMPDj8NsIAPw5+C0EAP48/BYCaOvTLSWQ8a8AaSGaYwkgQCyvdtUI0A5pbCEEiOXVrhoB2iGNLYQAsbzaVSNAO6SxhRAglle7agRohzS2EALE8mpXjQDtkMYWQoBYXu2qEaAd0thCCBDLq101ArRDGlvoN+inUIFR5rRYAAAAAElFTkSuQmCC) center/80% no-repeat'
    },
    '.brui-WindowDrag': {
      //background: 'url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAbklEQVRIS+2V4QoAEAyEedA93R6UUoTGDknC73O3fbRZs/nYzf7mB6iEpxERkeu5M3PwfjhAwpNjExFpXDXmjwVEhj0sEpJaX3xT5EJugOh/QBoXrTc7h0gdk5VguIM7A0arRvTT+wAxX1o4aIAHbFxkGVl7oCMAAAAASUVORK5CYII=) left/80% no-repeat'
    },
    '.brui-WindowMinimizar': {
      background: 'url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAA0klEQVRIS+1Uyw3DIAw1STsJM3FkF+/C0UuwC0vk0J9ApaJusFHU9FDFEif8/Pz8M7CzmZ3jAycwzrmJiG6ZGBENIt4BIL9N9nMFm7KUQIcCtaRfLZFzbiaia8v6QeC9LyO5LMuJO0vpVlwI4S1mlyAH4849ghp8DSMSDJAY731ZymqqguzYZiSRcL+U0jnGeBF7UD852Fo7I+IrW+2/xhGnaEXJ9FQolmVIQU8Jb7Q2CEN7wJU0Dc2KxEs7RAAA6rT0RniUoOB7y3RcU/Vi/neJHpNRWBlx1GFvAAAAAElFTkSuQmCC) center/80% no-repeat'
    },
    '.brui-WindowMaximizar.minIcon': {
      background: 'url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAaUlEQVRIS2NkoDFgBJkfGxv7H589ixcvBqtDB8Too68FuFxKaijCfAYyD8UHoxbAgnIYBhGpqYQU9VgzECkGEFI7agGhEGKgTxAhZwyCTiJCwTDMaKNBhKsqxahwcCWQwV8nE5G0yVYCAMNPgBkweU7MAAAAAElFTkSuQmCC) center/80% no-repeat'
    },
    '.brui-WindowMaximizar.maxIcon': {
      background: 'url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAeklEQVRIS+1VQQ7AIAjTh/I6HjqjiYmbwYJGsgNcFUor1JwuR671iehZ4TBzu/cNTZ4vgNSpVcXOrNZ7MXADQNpKjHqDkEEATBJZ5xu9wXi+tUABAL3pfxKNY6VxV8QgNll0b7XZWf1fcgL//wBNh9WzJgbXAE41X+UXRaC4GdcbTgQAAAAASUVORK5CYII=) center/80% no-repeat'
    },

    '.brui-Window-Wrapper': {
      position: 'absolute',
      top: '0',
      width: '100%',
      height: '100%',
      visibility: 'hidden',
    },
    '.brui-Window': {
      'min-width': '100px',
      'min-height': '100px',
      'position': 'absolute',
      'border': '1px solid #c8ccd0',
      'box-shadow': '0 0 8px 0 rgba(0,0,0,0.3)',
      'background-color': '#FFFFFF',
      visibility: 'visible',
    },
    '.brui-Window .brui-Window-Content': {
      padding: '0px',
      //height: 'calc(100% - 10px)',
      //display: 'flex',

      overflow: 'auto',
      position: 'absolute',
      
      //padding: '10px',
      'margin-top': '10px',
      top: '15px',
      bottom: '0',
      left: '0',
      right: '0',
    },
    
    '.brui-Splitter-Layout': {
      width: '100%',
      height: '100%'
    },
    
    '.brui-RunIcon': {
      width: runIconSize + 'px',
      height: runIconSize + 'px',
      'line-height': runIconSize + 'px',
      'text-align': 'center',
      'white-space': 'nowrap',
      'border-radius': '50%',
      position: 'absolute',
      'background-color': 'white',
      'box-shadow': '0 0 8px 0 rgba(0,0,0,0.3)',
      visibility: 'visible',
    },
    '.brui-RunIcon .brui-RunIcon-Label': {
      'background-color': '#fed9cc',
    },
    '.brui-RunIcon .brui-WindowDrag': {
      width: '100%',
      height: '100%',
      'background-image': 'none',
    },
    
    '.brui-Splitter': {
      'z-index': 10,
      position: 'absolute',
      border: '1px solid #c8ccd0',
    },
    
    '.brui-SplitterIcon': {
      position: 'absolute',
      width: iconSize + 'px',
      height: iconSize + 'px',
      //border: '1px solid #c8ccd0',
      'background-color': 'rgba(255,255,255,0.8)'
    },
    '.brui-Splitter .brui-SplitterIcon': {
      opacity: '0'
    },

    '.brui-Splitter:hover .brui-SplitterIcon': {
      opacity: '0.4'
    },
    '.brui-Splitter:hover .brui-SplitterIcon:hover': {
      opacity: '1'
    },

    '.brui-Splitter-horizontal': {
      cursor: 'e-resize',
      top: 0,
      bottom: 0,
    },
    '.brui-Splitter-horizontal .brui-SplitterIcon': {
      cursor: 'e-resize',
      top: '50%',
      left: '-10px',
      height: '20px',
      width: '20px',
      background: 'url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAh0lEQVRIS+2UQQ7AIAgE8aG8zoe24UBCEbt4oJfiyQRkzeyGQcVnFM+nHwkw8yU455zD3hHiNKIWWFAKEuGtBYTI9+u70IPIxIyAhsD+dhHQQb45K+DfPQTs8F38bEzfIqp4vxWQH5UiihJzkqKUyXZgWUwj81CKdob3LoIEYAPa96jeAogQ3VFmsBlbASBkAAAAAElFTkSuQmCC) rgba(0,0,0,0.2) center no-repeat',
    },
    '.brui-Splitter-vertical': {
      cursor: 'n-resize',
      left: 0,
      right: 0,
    },
    '.brui-Splitter-vertical .brui-SplitterIcon': {
      cursor: 'n-resize',
      top: '-10px',
      left: 'calc(50% - 5px)',
      height: iconSize + 'px',
      width: iconSize + 'px',
      background: 'url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAgElEQVRIS9WVUQ7AIAhD9aCcjoNu8YPEsGwtH9Xpr4YHLWBv4tPF8du/AGZ2jYrdnU6MfhjBQ1IWQgFy8AoEAt6CsxAImLtM6sEAnQFAmqPBzN318EAOQBlW79dXsFWiM9r0y0RJBcgTtFWpXSTdpiGZ9D/IECTL7CMlUXV6lwJu4PtIGZKJjy4AAAAASUVORK5CYII=) rgba(0,0,0,0.2) center no-repeat',
    },
    '.brui-Splitter-item': {
      height: '100%',
      position: 'relative',
      //'overflow': 'auto',
      //padding: '1px',
    },


    '.brui-icon': {
      width: iconSize + 'px',
      height: iconSize + 'px',
      border: '1px solid #f4f4f4',
    },
    '.brui-icon-minus': {
      //background: 'url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAb0lEQVRIS2NkoDFgpLH5DKMWEAzh0SAaWkEEi6//DAzg5A2iCYJhFsmxsbFEeZtguDAwMCxevBgcOihBNPQtIMLrRKcemFnkpCLk5ErQTSRZEBoayrx69ep/UFOJShAkWUDQuVgUjFpAMNSGfhABAFEHFRld8A+ZAAAAAElFTkSuQmCC) center center no-repeat',
    },
    '.brui-icon-plus': {
      //background: 'url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAqklEQVRIS+1TwQ3DIAw0STZhLu/iXfxkJvbgk6blYRQiKhNSR2pVfgi4891xDoyXM8aHP4Hq8CmLEHETRGbuett1SUB/jmACgGLZuzCGLfLez0T00FIeJrgacibO8vcDbI2Q5Z4IOe7rJu8BNOnauSisLPp+Ak22ddEcIpZvycwf70FFYNGDewlSSksIYdVy624yEU0xxgJ4tcnNwax/keZG87zboiH016MnBcZUGWDpJGwAAAAASUVORK5CYII=) center center no-repeat',
    }
    
  }
  
  BridgeUi.WindowFunc = {
    maxZindex : function() {
      var nodes = document.querySelectorAll('.brui-Window, .brui-Window-Wrapper');
      var zIndexs = Array.prototype.map.call(nodes, function(node) {
        return node.style.zIndex ? parseInt(node.style.zIndex) : 0;
      });
      zIndexs.push(100);
      var maxZindex = Math.max.apply(null, zIndexs);
      return maxZindex;
    }
  }
  
/*
  BridgeUi.WindowEvents = {
    mouseover: function(e) {
      this.style.opacity = 1;
    },
    mouseout: function(e) {
      this.style.opacity = 0.2;
    }
  }
*/
  ##
</template>




<template id="brui-WindowResize">
  ##
  var dragEvent = data.dragEvent;
  var clickPosition = null;
  var startPosition = null;
  var startSize = null;

  var event = Object.assign({}, BridgeUi.WindowEvents, {
    mousedown: function(e) {
      e = e.touches ? e.touches[0] : e;
      var target = this.parentElement;

      startSize = {x: target.clientWidth, y: target.clientHeight};
      startPosition = {x: e.pageX, y: e.pageY};
      clickPosition = {x: e.layerX, y: e.layerY};
    },
    drag: function(e, edata, tmplElem) {

      var target = this.parentElement;
      e = e.touches ? e.touches[0] : e;

      if (e.pageX == 0 //|| isOverflowed(target, e)
      ) {
        return;
      }

      if (target.scrollWidth <= (target.clientWidth) || startPosition.x < e.x) {
        target.style.width = (e.pageX - startPosition.x + startSize.x + 2) + 'px';
      }
      
      if (target.scrollHeight <= (target.clientHeight) || startPosition.y < e.y) {
        target.style.height = (e.pageY - startPosition.y + startSize.y + 2) + 'px';
      }
      
      if (dragEvent) dragEvent(e, edata, tmplElem);
    },
    touchstart: function(e) {
      //event.mouseover.call(this, e);
      event.mousedown.call(this, e);
    },
    /*
    touchend: function(e) {
      var self = this;
      setTimeout(function() {
        event.mouseout.call(self, e);
      }, 1500);
    },
    */
    touchmove: function(e) {
      event.drag.call(this, e);
    }
  });
  ##
  <div style="##=data.style ? BridgeUi.toStyle(data.style) : ''##"
        class="brui-WindowIcon brui-WindowResize ##=data.class##"
        draggable="true"
        data-event="##:event##">
  </div>
</template>

<template id="brui-WindowDrag">
  ##
  //var beforePosition = null;
  var clickPosition = null;
  var startPosition = null;
  
  var target = null;
  var targetParent = null;
  
  var event = Object.assign({}, BridgeUi.WindowEvents, {
    /*
    mouseover: function(e) {
      e = e.touches ? e.touches[0] : e;
      target = this.parentElement;
      target.style.position = 'absolute';
      //this.style.opacity = 1;
    },
    */
    mousedown: function(e) {
      e = e.touches ? e.touches[0] : e;
      target = this.parentElement;
      targetParent = target.parentElement;
      clickPosition = {x: e.layerX || 0, y: e.layerY || 0};
      startPosition = {x: parseInt(e.pageX - target.offsetLeft) || 0, y: parseInt(e.pageY - target.offsetTop) || 0};

    },
    drag: function(e, edata, tmplElem) {
      e = e.touches ? e.touches[0] : e;

      if (e.x == 0) {
        return;
      }
      
      //target.style.left = Math.max(0, e.pageX - startPosition.x)+ 'px';
      //target.style.top = Math.max(0, e.pageY - startPosition.y) + 'px';
      
      target.style.left = Math.min(Math.max(0, e.pageX - startPosition.x), targetParent.offsetWidth - target.offsetWidth)+ 'px';
      target.style.top = Math.min(Math.max(0, e.pageY - startPosition.y), targetParent.offsetHeight - target.offsetHeight) + 'px';
      
    },
    touchstart: function(e) {
      //event.mouseover.call(this, e);
      event.mousedown.call(this, e);
    },
    /*
    touchend: function(e) {
      var self = this;
      setTimeout(function() {
        event.mouseout.call(self, e);
      }, 1500);
    },
    */
    touchmove: function(e) {
      event.drag.call(this, e);
    }
  });
  ##
  <div style="##=data.style ? BridgeUi.toStyle(data.style) : ''##"
        class="brui-WindowIcon brui-WindowDrag ##=data.class##"
        draggable="true"
        data-event="##:event##">
  </div>
</template>
  


<template id="brui-WindowMaximizar">
  ##
  var isFull = false;
  var beforePosition = {};
  
  var icon = null;
  
  var event = Object.assign({}, BridgeUi.WindowEvents, {
    click: function(e) {
      var target = this.parentElement;
      var classList = e.currentTarget.classList;
      
      if (!isFull) {
        beforePosition = {
          left: target.style.left,
          top: target.style.top,
          width: target.style.width,
          height: target.style.height,
          maxWidth: target.style.maxWidth,
          maxHeight: target.style.maxHeight
        }

        target.style.left = 0;
        target.style.top = 0;
        target.style.bottom = 0;
        target.style.right = 0;
        target.style.width = 'initial';
        target.style.maxWidth = 'initial';
        target.style.height = 'initial';
        target.style.maxHeight = 'initial';
        isFull = true;
        
        classList.remove('maxIcon');
        classList.add('minIcon');
        
      } else {
        target.style.left = beforePosition.left;
        target.style.top = beforePosition.top;
        target.style.bottom = 'initial';
        target.style.right = 'initial';
        target.style.width = beforePosition.width;
        target.style.height = beforePosition.height;
        target.style.maxWidth = beforePosition.maxWidth;
        target.style.maxHeight = beforePosition.maxHeight;
        isFull = false;
        
        classList.remove('minIcon');
        classList.add('maxIcon');
      }
    }
  });
  ##
  <div style="##=data.style ? BridgeUi.toStyle(data.style) : ''##"
        class="brui-WindowIcon brui-WindowMaximizar maxIcon ##=data.class##"
        draggable="false"
        data-event="##:event##">
  </div>
</template>

<template id="brui-WindowMinimizar">
  ##
  var isMin = false;
  var beforeHeight = null;
  var beforeOverflow = null;
  var beforeContentDisplay = null;
  var target = null;
  
  var runIcon = data.runIcon || {};
  var runIconStyle = runIcon.style;
  
  var runIconElement = tmpl.brui.RunIcon(Object.assign(runIcon, {event: function(e, edata, tmplElem) {
    runIconStyle = Object.assign(runIconStyle || {}, {left: runIconElement.offsetLeft + 'px', top: runIconElement.offsetTop + 'px'});
    runIconElement.remove();
    target.style.display = beforeContentDisplay;
    isMin = false;
  }}));
  
  var event = Object.assign({}, BridgeUi.WindowEvents, {
    click: function(e) {
      target = this.parentElement;
      //var content = target.querySelector('.brui-Window-Content');
      //var icons = target.querySelectorAll('.brui-WindowIcon');

      runIconElement = runIconElement.reflash({style: runIconStyle || {left: target.offsetLeft + 'px', top: target.offsetTop + 'px'}});
      beforeContentDisplay = target.style.display;
      target.style.display = 'none';
      target.parentElement.appendChild(runIconElement.element || runIconElement);
      isMin = true;

      /*
      if (!isMin) {
        beforeHeight = target.style.height;
        beforeOverflow = target.style.overflow;
        target.style.height = e.target.style.height;
        target.style.overflow = 'hidden';
        isMin = true;
      } else {
        target.style.height = beforeHeight;
        target.style.overflow = beforeOverflow;
        isMin = false;
      }
      */
    }
  });
  ##
  <div style="##=data.style ? BridgeUi.toStyle(data.style) : ''##"
      class="brui-WindowIcon brui-WindowMinimizar ##=data.class##"
      draggable="false"
      data-event="##:event##">
  </div>
  ###
  tmplScope.toIcon = event.click;
  ##
</template>


<template id="brui-RunIcon">
  <div style="##=data.style ? BridgeUi.toStyle(data.style) : ''##"
        class="brui-RunIcon ##=data.class##"
        draggable="false"
        data-event="##:data.event##">
    ##%tmpl.brui.WindowDrag(data.windowDrag || {style: {}})##
    <span class="brui-RunIcon-Label">##=data.label##</span>
  </div>
</template>

<template id="brui-WindowCloser">
  ##
  var event = Object.assign({}, BridgeUi.WindowEvents, {
    click: function() {
      var target = this.parentElement;
      target.remove();
    }
  });
  ##
  <div style="##=data.style ? BridgeUi.toStyle(data.style) : ''##"
        class="brui-WindowIcon brui-WindowCloser ##=data.class##"
        draggable="false"
        data-event="##:event##">
  </div>
</template>

<template id="brui-Window">
  ##
  var dialogs = document.querySelectorAll('.brui-Window');
  var dialogCount = dialogs.length;
  ##
  <div style="left: ##=dialogCount * 20##px;
              top: ##=dialogCount * 20##px;
              z-index: ##=BridgeUi.WindowFunc.maxZindex() + 1##;
              ##=data.style##"
        class="brui-Window ##=data.class##"
        data-event="##:data.event || function(e, edata, tmplElem){
          tmplElem.style.zIndex = BridgeUi.WindowFunc.maxZindex() + 1;
        }##">
    
    ##%minimizar=tmpl.brui.WindowMinimizar(Object.assign({style: {left:'0', top: '0'}, runIcon : data.runIcon || {label: data.title || data.runIconLabel}}, data.windowMin))##
    ##%tmpl.brui.WindowDrag(Object.assign({style: {left:'20px', right:'40px', top: '0', width: 'initial'}}, data.windowDrag))##
    ##%tmpl.brui.WindowMaximizar(Object.assign({style: {right:'20px', top: '0'}}, data.windowMax))##
    ##%tmpl.brui.WindowCloser(Object.assign({style: {right:'0', top: '0'}}, data.windowClose))##
    <div class="brui-Window-Title ##=data.titleClass##" data-event="##:{var: 'title'}##">##=data.title##</div>
    <div class="brui-Window-Content ##=data.contentClass##" style="##=data.contentStyle##">
      ##%data.content##
    </div>
    ##%bridge.tmpl('brui-WindowResize')(Object.assign({style: {right:'0', bottom: '0'}}, data.windowResize))##
  </div>
</template>

<template id="brui-Splitter">
  ##
  var direction = data.direction != 'vertical' ? 'horizontal' : 'vertical';
  var widthMargin = data.widthMargin || '4px';
  var minSize = data.minSize || 5;
  
  var splitterSize = null;
  var targetStartSize = null;
  var targetPrevStartSize = null;
  var clickPosition = null;
  var startPosition = null;
  var fullWidth = null;
  var fullPercentageWidth = null;
  var fullHeight = null;
  var fullPercentageHeight = null;
  
  var parent = null;
  var target = null;
  var targetPrev = null;
  
  var isMove = false;

  var isOverflowed = function(direction, target, prevTarget, event) {
    if (direction == 'horizontal') {
      var isPrevOver = prevTarget.scrollWidth > prevTarget.clientWidth;
      var isPrevStartOver = startPosition.x <= event.pageX;
      var isOver = target.scrollWidth > target.clientWidth;
      var isStartOver = startPosition.x >= event.pageX;
      var result = (isPrevStartOver ? false : isPrevOver) || (isStartOver ? false : isOver);
      return result;
    } else {
      var isPrevOver = prevTarget.offsetHeight > prevTarget.scrollHeight;
      var isPrevStartOver = startPosition.y <= event.pageY;
      var isOver = target.offsetHeight > target.scrollHeight;
      var isStartOver = startPosition.y >= event.pageY;
      var result = (isPrevStartOver ? false : isPrevOver) || (isStartOver ? false : isOver);
      return result;
    }
  }

  var crt = document.createElement('img');
  crt.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVQYV2NgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII=";
  crt.style.visibility = "hidden";
  var event = Object.assign({}, BridgeUi.WindowEvents, {
    mousedown : function(e) {
      //e.stopPropagation();
      //e.preventDefault();

      e = e.touches ? e.touches[0] : e;
      target = this.parentElement;
      targetPrev = target.previousElementSibling;
      parent = target.parentElement;
      splitterSize = {x: e.target.offsetWidth, y: e.target.offsetHeight};
      targetStartSize = {x: target.offsetWidth, y: target.offsetHeight};
      targetPrevStartSize = {x: targetPrev.offsetWidth, y: targetPrev.offsetHeight};
      
      clickPosition = {x: e.layerX || 0, y: e.layerY || 0};
      startPosition = {x: parseInt(e.pageX) || 0, y: parseInt(e.pageY) || 0};

      var pattern = /(\d+[.\d]*)/ig;
      if (targetPrev.style.width) {
        fullWidth = targetPrev.clientWidth + target.clientWidth;
        fullPercentageWidth = parseFloat(targetPrev.style.width.match(pattern)[0]) + parseFloat(target.style.width.match(pattern)[0]);
      }
      if (targetPrev.style.height) {
        fullHeight = targetPrev.clientHeight + target.clientHeight;
        fullPercentageHeight = parseFloat(targetPrev.style.height.match(pattern)[0]) + parseFloat(target.style.height.match(pattern)[0]);
      }
      
      isMove = true;
    },
    mouseup: function(e) {
      isMove = false;
    },
    dragstart: function(e) {
      if (e.dataTransfer && e.dataTransfer.setDragImage) {
        
        //var crt = e.target.cloneNode(true);
        //crt.style.display = "none";
        e.dataTransfer.setDragImage(crt, 0, 0);
      }
    },
    drag: function(e) {
      e = e.touches ? e.touches[0] : e;
      if (!isMove || e.pageX == 0 || isOverflowed(direction, target, targetPrev, e)
      ) return;

      if (direction == 'horizontal') {
        var moveSize = e.pageX - startPosition.x;
        var afterTargePrevWidth = (targetPrevStartSize.x + moveSize) * fullPercentageWidth / fullWidth;
        var afterTargeWidth = fullPercentageWidth - afterTargePrevWidth;
        
        if (afterTargePrevWidth < minSize || afterTargeWidth < minSize) return;
        
        targetPrev.style.width = 'calc(' + afterTargePrevWidth + '% - ' + widthMargin + ')';
        target.style.width = 'calc(' + afterTargeWidth + '% - ' + widthMargin + ')';
      } else {
        var moveSize = e.pageY - startPosition.y;
        var afterTargePrevHeight = (targetPrevStartSize.y + moveSize) * fullPercentageHeight / fullHeight;
        var afterTargeHeight = fullPercentageHeight - afterTargePrevHeight;
        
        if (afterTargePrevHeight < minSize || afterTargeHeight < minSize) return;
        
        targetPrev.style.height = 'calc(' + afterTargePrevHeight + '% - ' + widthMargin + ')';
        target.style.height = 'calc(' + afterTargeHeight + '% - ' + widthMargin + ')';
      }
    },
    touchstart: function(e) {
      event.mousedown.call(this, e);
    },
    /*
    touchend: function(e) {
      var self = this;
      setTimeout(function() {
        event.mouseout.call(self, e);
      }, 1500);
    },
    */
    touchmove: function(e) {
      //e.preventDefault();
      event.drag.call(this, e);
    }
  });
  ##
  <div style="##=data.style ? BridgeUi.toStyle(data.style) : ''##"
        class="brui-Splitter brui-Splitter-##=direction## ##=data.class##"
        draggable="true"
        data-event="##:event##">
    <span class="brui-SplitterIcon">
  </div>
</template>

<template id="brui-Splitter-Layout">
  <div class="brui-Splitter-Layout" class="##=data.class##" style="##=data.style##">
  ##
  var style = data.style;
  var direction = tmplScope.direction = data.direction != 'vertical' ? 'horizontal' : 'vertical';
  //var widthMargin = data.widthMargin || '4px';
  var items = data.items || [];
  var layoutStyle = null;
  
  var splitterDivs = [];
  var setSplitterDiv = function(target, index) {
    splitterDivs[index] = target;
  }

  tmplScope.splitterDivs = splitterDivs;

  var spanSizeSum = 0;
  var contentItems = [];
  items.forEach(function(item, index) {
    if (item instanceof Node) {
      item = {content: item, span: 1};
    } else if(item.element) {
      item = {content: item.element, span: 1};
    } else {
      if (!item.span) item.span = 1;
    }
    contentItems.push(item);
    spanSizeSum += item.span;
  });

  var lastPercent = 100;
  var spanPercent = Math.floor(100 / spanSizeSum * 100) / 100;
  var lastIndex = items.length - 1;
  var calcPercent = null;
  var sizeValue = null;
  contentItems.forEach(function(contentItem, index) {
    calcPercent = spanPercent * contentItem.span;

    if (index != lastIndex) {
      sizeValue = 'calc(' + calcPercent + '%)';
      lastPercent -= calcPercent;
    } else {
      sizeValue = 'calc(' + lastPercent + '%)';
    }

    if (direction == 'horizontal') {
      layoutStyle = {
        'float': 'left',
        'width':  sizeValue,
      }
    } else {
      layoutStyle = {
        'height': sizeValue,
      }
    }
  ##
    <div class="brui-Splitter-item ##=contentItem.class##" style="##=BridgeUi.toStyle(layoutStyle)## ##=contentItem.style##" data-event="##:{load:setSplitterDiv}::index##">
      ##%index == 0 ? null : tmpl.brui.Splitter(data.Splitter || {direction: data.direction})##
      ##%contentItem.content##
    </div>
  ##})##
  </div>
</template>

<template id="brui-Layout">
  <div class="brui-Layout">
  ##
  var style = data.style;
  var direction = data.direction != 'vertical' ? 'horizontal' : 'vertical';
  //var widthMargin = data.widthMargin || '4px';
  var items = data.items || [];
  var layoutStyle = null;
  
  var divs = [];
  var setDiv = function(target, index) {
    divs[index] = target;
  }

  tmplScope.divs = divs;

  var spanSizeSum = 0;
  items.forEach(function(item, index) {
    if (item instanceof Node) {
      item = items[index] = {content: item, span: 1};
    } else {
      if (!item.span) item.span = 1; 
    }
    spanSizeSum += item.span;
  });
  
  var lastPercent = 100;
  var spanPercent = Math.floor(100 / spanSizeSum * 100) / 100;
  var lastIndex = items.length - 1;
  var calcPercent = null;
  var sizeValue = null;
  items.forEach(function(item, index) {
    calcPercent = spanPercent * item.span;

    if (index != lastIndex) {
      sizeValue = 'calc(' + calcPercent + '%)';
      lastPercent -= calcPercent;
    } else {
      sizeValue = 'calc(' + lastPercent + '%)';
    }

    if (direction == 'horizontal') {
      layoutStyle = {
        'float': 'left',
        'width':  sizeValue,
      }
    } else {
      layoutStyle = {
        'height': sizeValue,
      }
    }
  ##
    <div class="brui-Layout-item ##=item.class##" style="##=style## ##=BridgeUi.toStyle(layoutStyle)## ##=item.style##" data-event="##:{load:setDiv}::index##">
      ##%item.content##
    </div>
  ##})##
  </div>
</template>

<template id="brui-GanttChart-Content-Line">
  ##
//console.log(data.item);
  var item = data.item || [];
  var itemKey = Object.assign({label: 'label', items: 'items', 'items.label': 'label', 'items.startDate': 'startDate', 'items.endDate': 'endDate', 'items.color': 'color'}, data.itemKey || {});
  var datePeriodArray = data.datePeriodArray || [];
  var weekColor = data.weekColor || [];
  var nowTime = data.nowTime;
  if (!nowTime) {
    var nowDate = new Date();
    nowDate.setHours(0, 0, 0, 0);
    nowTime = nowDate.getTime();
  }
  var dayHeight = data.dayHeight || 24;
  var oneDayWidth = data.oneDayWidth || 20;
  var lineHeight = data.lineHeight || 10;
  
  var eventData = {};
  var itemKeyItemsLabel = itemKey['items.label'];
  var itemKeyItemsStartDate = itemKey['items.startDate'];
  var itemKeyItemsEndDate = itemKey['items.endDate'];
  var itemKeyItemsColor = itemKey['items.color'];
  
  var eventItems = item[itemKey.items] || [];
  eventItems.forEach(function(item, index) {
    var date = new Date(item[itemKeyItemsStartDate]);
    date.setHours(0, 0, 0, 0)
    var key = date.getTime();
    if (!eventData[key]) eventData[key] = [];
    eventData[key].push(item);
  });

  var lineCount = 0;
  ##
  <div class="brui-GanttChart-Content-Line" style="font-size: 0px;">
    <div class="label" style="height: ##=dayHeight + (lineHeight * eventItems.length)##px;">##=itemKey.label instanceof Function ? itemKey.label(item) : item[itemKey.label]##</div>
    <div class="cell">
      ##datePeriodArray.forEach(function(date, index) {
        var dateTime = date.getTime();
      ##
      <div class="date ##=weekColor[date.getDay()] || ''## ##=dateTime == nowTime ? 'now' : ''##" style="width: ##=oneDayWidth - 1##px; height: ##=dayHeight + (lineHeight * eventItems.length)##px;">
        ##var eventDataArray = eventData[dateTime];
          if (eventDataArray) {
            eventDataArray.forEach(function(event) {
              lineCount++;
              var startDate = itemKeyItemsStartDate instanceof Function ? itemKeyItemsStartDate(event, eventItems) : event[itemKeyItemsStartDate];
              var endDate = itemKeyItemsEndDate instanceof Function ? itemKeyItemsEndDate(event, eventItems) : event[itemKeyItemsEndDate];
              if (startDate && !(startDate instanceof Date)) startDate = new Date(startDate);
              if (!endDate) endDate = new Date(startDate.getTime());
              if (endDate && !(endDate instanceof Date)) endDate = new Date(endDate);
              var lineColor = itemKeyItemsColor instanceof Function ? itemKeyItemsColor(event) : event[itemKeyItemsColor];
              var diffTime = endDate.getTime() - startDate.getTime();
        ##
              <div class="line" style="##=lineColor ? 'background-color: ' + lineColor + ';' : ''## top: ##=lineHeight * lineCount##px; width: ##=oneDayWidth * ((diffTime > 0 ? diffTime : 0) + 86400000) / 86400000##px;">
                ##=itemKeyItemsLabel instanceof Function ? itemKeyItemsLabel(event) : event[itemKeyItemsLabel]##
              </div>
        ##  });
          }##
      </div>
      ##});##
    </div>
  </div>
</template>
<template id="brui-GanttChart">
  ##
  var items = data.items || [];
  var itemKey = data.itemKey || {};
  var oneDayWidth = data.oneDayWidth || 20;
  
  var startDate = typeof data.startDate === 'string' ? new Date(data.startDate)  : data.startDate;
  startDate.setHours(0, 0, 0, 0);
  var endDate = typeof data.endDate === 'string' ? new Date(data.endDate)  : data.endDate;
  endDate.setHours(0, 0, 0, 0);
  
  var period = data.period;
  var itemsList = data.itemList || [];
  
  var datePeriodArray = [startDate];
  var yearArray = [{year: startDate.getFullYear(), month: startDate.getMonth() + 1}];
  var tempDate = startDate;
  var beforeDate = startDate;
  var days = 0;
  while (tempDate.getTime() < endDate.getTime()) {
    days++;
    tempDate = new Date(tempDate.getTime());
    tempDate.setDate(tempDate.getDate()+1)
    datePeriodArray.push(tempDate);
    if (beforeDate.getMonth() != tempDate.getMonth()) {
      yearArray[yearArray.length - 1].span = days;
      yearArray.push({year: tempDate.getFullYear(), month: tempDate.getMonth() + 1});
      days = 0;
    }
    beforeDate = tempDate;
  }
  yearArray[yearArray.length - 1].span = days + 1;

  var weekColor = {
    6: 'saturday',
    0: 'sunday'
  };
  
  var nowDate = new Date();
  nowDate.setHours(0, 0, 0, 0);
  var nowTime = nowDate.getTime();
  ##
  <div class="brui-GanttChart">
    <style id="style-brui-GanttChart">
      .brui-GanttChart .brui-GanttChart-contetnt {
        overflow: auto;
        white-space: nowrap;

        /*position: absolute;*/
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
      }
      .brui-GanttChart .cell > div {
        display: inline-block;
        text-align: center;
        font-size: 12pt;
        border: 1px solid #EAEAEA;
        border-left-width: 0px;
        height: 24px;
        vertical-align: top;
      }
      .brui-GanttChart .cell > .year {
        line-height: 24px;
      }
      .brui-GanttChart .cell > .day {
        
      }
      .brui-GanttChart .cell > .date {
        position: relative;
      }
      .brui-GanttChart .cell > .saturday {
        background-color: #C7E0F4;
      }
      .brui-GanttChart .cell > .sunday {
        background-color: #fde7e9;
      }
      .brui-GanttChart .cell > .now {
        /*border: 1px solid #0078d7;*/
        margin-left: -1px;
        background: repeating-linear-gradient(-45deg, transparent, transparent 3px, rgba(234,234,234,0.8) 3px, rgba(234,234,234,0.8) 5px);
      }
      .brui-GanttChart .cell > .sunday.now {
        background: repeating-linear-gradient(-45deg, transparent, transparent 3px, rgba(253,231,233,0.8) 3px, rgba(253,231,233,0.8) 5px);
      }
      .brui-GanttChart .cell > .saturday.now {
        background: repeating-linear-gradient(-45deg, transparent, transparent 3px, rgba(199,224,244,0.8) 3px, rgba(199,224,244,0.8) 5px);
      }
      .brui-GanttChart .label {
        /*width: 100px;*/
        text-align: left;
        font-size: 12pt;
        border: 1px solid #EAEAEA;
        border-left-width: 0px;
        padding-left: 5px;
        position: absolute;
        background-color: #f4f4f4;
        z-index: 2;
      }
      .brui-GanttChart .chart-header .label {
        height: 50px;
      }
      
      .brui-GanttChart .line {
        position: absolute;
        height: 10px;
        background-color: red;
        font-size: 10px;
        color: white;
        z-index: 1;
      }
      
      .brui-GanttChart .brui-GanttChart-Content-Line {
        /*position: relative;*/
      }
    </style>
    <div class="brui-GanttChart brui-GanttChart-header">

    </div>
    <div class="brui-GanttChart brui-GanttChart-contetnt">
      <div class="chart-wrapper">
        <div class="chart-header" style="font-size: 0px;">
          <div class="label"></div>
          <div class="cell">
            ##yearArray.forEach(function(item) {##
            <div class="year" style="width: ##=(oneDayWidth * item.span) - 1##px;">##=item.year##-##=('0' + item.month).slice(-2)##</div>
            ##});##
            <br/>
            ##datePeriodArray.forEach(function(date) {##
            <div class="day ##=weekColor[date.getDay()] || ''## ##=date.getTime() == nowTime ? 'now' : ''##" style="width: ##=oneDayWidth - 1##px; ">##=date.getDate()##</div>
            ##});##
          </div>
        </div>
        ##items.forEach(function(item) {##
          ##%tmpl.brui.GanttChartContentLine({item: item, itemKey: itemKey, datePeriodArray: datePeriodArray, weekColor: weekColor, nowTime: nowTime, oneDayWidth: oneDayWidth})##
        ##});##

      </div>
    </div>
    <div class="brui-GanttChart brui-GanttChart-footer"></div>
  </div>
  ###
  if (!document.head.querySelector('#style-brui-GanttChart')) {
    document.head.appendChild(this.querySelector('#style-brui-GanttChart'));
  } else {
    var style = this.querySelector('#style-brui-GanttChart');
    if (!style) style.parentElemnt.remove(style);
  }

  var content = this.querySelector('.brui-GanttChart-contetnt');
  var now = this.querySelector('.now');
  var labels = this.querySelectorAll('.label');
  var cells = this.querySelectorAll('.cell');
  setTimeout(function() {
    var widhtArray =Array.prototype.map.call(labels, function(elem){
      return elem.offsetWidth;
    });
    var maxWidth = Math.max(...widhtArray);
    Array.prototype.forEach.call(labels, function(elem){
      elem.style.width = maxWidth + 'px';
    });
    Array.prototype.forEach.call(cells, function(elem){
      elem.style.paddingLeft = (maxWidth + 5) + 'px';
    });
    content.scrollLeft = now.offsetLeft - (content.offsetWidth / 2); //+ oneDayWidth;

  }, 0);
  ##
</template>

<template id="brui-Div">
  <div class="##=data.class##" style="##=data.style##">
  ##if (typeof data.content === 'string') {## 
    ##=data.content##
  ##} else {##
    ##%data.content##
  ##}##
  </div>
</template>

<template id="brui-Style">
  <style>
    ##
    Object.keys(data).forEach(function(key) {
    ##
    ##=key## {
      ##=BridgeUi.toStyle(data[key])##
    }
    ##});##
  </style>
</template>


<template id="brui-Tag">
  ##%BridgeUi.HtmlObj.tag(data[0], data[1])##
</template>


<template id="brui-Viewport">
  ##
  var setScale = function(value) {
    var viewport = document.querySelector('meta[name="viewport"]');
    viewport.content = 'width=device-width, initial-scale=' + value + ', maximum-scale=' + value + ', user-scalable=no';
  }
  ##
  <select data-event="##:{change: function(e) {
        var value = e.target.value;
        localStorage['viewport_scale'] = e.target.value;
        setScale(value);
      }}##"
      id="viewport-scale"
      class="brui-Viewport ##=data.class##">
    ##
    var sv = 0;
    var selected = false;
    var value = localStorage['viewport_scale'] || 1;
    setScale(value);
    for (var i=150; i > 49; i=i-5) {
        sv = i / 100;
        selected = value == sv;
    ##
    &lt;option value="##=sv##" ##=selected ? 'selected="selected"' : ""##&gt;x ##=sv##&lt;/option&gt;
    ##}##
  </select>
</template>

<template id="brui-RangeButton">
  ##
  var min = data.min;
  var max = data.max;
  var prefix = data.prefix;
  var subfix = data.subfix;
  var step = data.step || 1;
  var value = data.value || 0;
  var valueElement = BridgeUi.HtmlObj.tag('span', {innerText: value});
  var changeEvent = data.changeEvent;
  ##
  <div class="brui-RangeButton ##=data.class##" style="##=data.style##">
    <button type="button" class="brui-icon brui-icon-plus" data-event="##:function(e, edata, tmplElem) {
      if (value + step > max) return;
      value += step;
      tmplElem.value = valueElement.innerText = value;
      if (changeEvent) changeEvent.call(this, e, value, tmplElem);
    }##"> + </button>
    ##=prefix####%valueElement####=subfix##
    <button type="button" class="brui-icon brui-icon-minus" data-event="##:function(e, edata, tmplElem) {
      if (value - step < min) return;
      value -= step;
      tmplElem.value = valueElement.innerText = value;
      if (changeEvent) changeEvent.call(this, e, value, tmplElem);
    }##"> - </button>
  </div>
</template>


<template id="brui-AfterLoad" data-bridge-load-script="true">
  ##
  var windowStyle = tmpl.brui.Style(BridgeUi.WindowStyle);
  document.head.appendChild(windowStyle.element || windowStyle);
  ##
</template>




<script>
var isEdge = function() {
  var myNav = navigator.userAgent.toLowerCase();
  return (myNav.indexOf('edge') != -1) ? true : false;
}

if (bridge.tmplTool) {
  var importDoc = (document._currentScript || document.currentScript).ownerDocument;
  bridge.tmplTool.addTmpls(importDoc.body.innerHTML);
  console.log('bridge.ui.components.html');
} else {
  console.log('bridge.ui.components.html', 'bridge.tmplTool unload.');
}
</script>

</body>
