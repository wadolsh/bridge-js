<body>
<template id="ta-TestArea">
  <style id="style-ta-TestArea">
    .ta-TestArea {
      height: 345px;
      border: 1px solid #ccc;
      margin: 0 0 10px;
    }
    .ta-TestArea.console {
      height: 545px;
    }
    .ta-TestArea.template {
      height: 667px;
    }
    .ta-TestArea.template.console {
      height: 867px;
    }
    .ta-TestArea > .controlArea {
      height: 22px;
      border-top: 1px solid #ccc;
      background-color: #f7f7f7;
    }
    .ta-TestArea > .controlArea .btn {
      border-radius: 0px;
      border: 1px solid #f7f7f7;
    }
    .ta-TestArea > .controlArea .btn.right {
      float: right;
    }
    .ta-TestArea .splitter-title {
      background-color: #f7f7f7;
      border-bottom: 1px solid #ccc;
      height: 20px;
      padding-left: 5px;
    }
    .ta-TestArea .brui-Splitter-Layout.code,
    .ta-TestArea .brui-Splitter-Layout.template {
      height: calc(100% - 23px);
    }
    .ta-TestArea.template .brui-Splitter-Layout.template .brui-Splitter-Layout.code {
      height: calc(100% - 0px);
    }
    .ta-TestArea.console .brui-Splitter-Layout.code,
    .ta-TestArea.console .brui-Splitter-Layout.template {
      height: calc(100% - 223px);
    }
    /*
    .ta-TestArea.template.console .brui-Splitter-Layout.template .brui-Splitter-Layout.code {
      height: calc(100% - 200px);
    }
    */
    .ta-TestArea .codeMirrorArea {
      position: absolute;
      top: 20px;
      bottom: 0;
      left: 0;
      right: 0;
    }
    .ta-TestArea .CodeMirror {
      height: 100%;
    }
  </style>
  ##
  var imports = data.imports;
  var template = data.template;
  var hasTemplate = !!template;
  var code = data.code;
  var type = data.type;
  var showConsole = data.showConsole || false;
  var autoReflash = true;

  var codeMirrorArea = tmpl.br.Div({class: 'codeMirrorArea'});
  var renderingArea = tmpl.ta.RenderingArea({imports: imports, code: code, type: type, template: template});
  var consoleArea = tmpl.ta.ConsoleArea({show: showConsole});

  var codeMirror = null;
  var codeSpliteArea = tmpl.brui.SplitterLayout({
    class: 'code',
    direction: '',
    items: [[tmpl.br.Div({class: 'splitter-title', content: 'Run Code'}), codeMirrorArea], [tmpl.br.Div({class: 'splitter-title', content: 'Result'}), renderingArea]]
  });
  
  var templateCodeMirrorArea = tmpl.br.Div({class: 'codeMirrorArea'});
  var templateSpliteArea = !hasTemplate ? null : tmpl.brui.SplitterLayout({
    class: 'template',
    direction: 'vertical',
    items: [[tmpl.br.Div({class: 'splitter-title', content: 'Template'}), templateCodeMirrorArea], codeSpliteArea]
  });

  ##
  <div class="ta-TestArea ##=hasTemplate ? 'template' : ''## ##=showConsole ? 'console' : ''##">
    ##%templateSpliteArea || codeSpliteArea##
    <div class="controlArea">
      ##%tmpl.bs.Button({label: 'AUTO REFLASH', icon: 'refresh', styleClass: 'xs ' + (autoReflash ? 'btn-success' : ''), event: function(e, edata, tmplElem) {
        autoReflash = !autoReflash;
        tmplElem.classList[autoReflash ? 'add' : 'remove']('btn-success');
      }})##
      ##%tmpl.bs.Button({label: 'CODE RESET', icon: 'repeat', styleClass: 'xs', event: function() {
        codeMirror.setValue(code);
      }})##
      ##%tmpl.bs.Button({label: 'RUN', icon: 'play', styleClass: 'xs', event: function() {
        renderingArea.reflashCode({code: codeMirror.getValue()});
      }})##
      ##%tmpl.bs.Button({label: 'CONSOLE', icon: '', styleClass: 'xs right ' + (showConsole ? 'btn-info' : ''), event: function(e, edata, tmplElem) {
        showConsole = !showConsole;
        consoleArea.show(showConsole);
        tmplScope.element.classList[showConsole ? 'add' : 'remove']('console');
        tmplElem.classList[showConsole ? 'add' : 'remove']('btn-info');
      }})##
    </div>
    ##%consoleArea##
  </div>
  ###
  setTimeout(function() {
    codeMirror = CodeMirror(codeMirrorArea.element, {
      value: code,
      lineNumbers: true,
      mode: "javascript"
    })
    codeMirror.on('change',function(cMirror) {
      if (autoReflash) renderingArea.reflashCode({code: cMirror.getValue(), type: type});
    });

    if (hasTemplate) {
      templateCodeMirror = CodeMirror(templateCodeMirrorArea.element, {
        value: template,
        lineNumbers: true,
        mode: "javascript"
      })
      templateCodeMirror.on('change',function(cMirror) {
        if (autoReflash) renderingArea.reflashResult({template: cMirror.getValue(), type: type});
      });
    }
    consoleArea.setWindow(renderingArea.window);
  });
  ##
</template>

<template id="ta-Rendering-Area">
  <style id="style-ta-Rendering-Area">
    .ta-Rendering-Area, .ta-Rendering-Area {
      height: calc(100% - 22px);
    }
    .ta-Rendering-Area iframe {
      border: 0;
      width: 100%;
      height: calc(100% - 0px);
    }
  </style>
  ##
  var imports = data.imports || [];
  var template = data.template;
  var code = data.code;
  var type = data.type;
  var loadCount = 0;
  var hasImport = false;

  var importOptionTags = {
    css: function(item) {
      return tmpl.br.Tag(['link', {href: item.text, rel: "stylesheet", type: "text/css"}]);
    },
    js: function(item) {
      loadCount++;
      return tmpl.br.Tag(['script', {src: item.text, onload: function () {
        loadCount--;
        if (loadCount == 0) {
          execScript(code);
        }
      }}]);
    },
    import: function(item) {
      hasImport = true;
      loadCount++;
      return tmpl.br.Tag(['link', {href: item.text, rel: "import", onload: function () {
        loadCount--;
        if (loadCount == 0) {
          execScript(code);
        }
      }}]);
    },
    tmpl: function(item) {
      hasImport = true;
      loadCount++;
      return tmpl.br.Tag(['link', {href: '/tmpls?template_group_id=' + item.text, rel: "import", onload: function () {
        loadCount--;
        if (loadCount == 0) {
          setTimeout(function() {
            execScript(code);
          });
        }
      }}]);
    }
  }

  var createImportElement = function(item) {
    var tag = importOptionTags[item.type];
    return tag ? tag(item) : null;
  }

  var execScript = function(code) {
    if (!code) return;
    var head = iframeDocument.head;
    var body = iframeDocument.body;
    
    if (template && type == 'codeIsTemplate') {
      var oldTemplateSctipt = iframeDocument.getElementById('templateScript');
      if (oldTemplateSctipt) head.removeChild(oldTemplateSctipt);
      template.forEach(function(tmplData) {
        iframeWindow.bridge.tmplTool.addTmpl(tmplData.key, tmplData.code);
      });
      
    } else if (template && type == 'codeIsTemplateFile') {
      var oldTemplateSctipt = iframeDocument.getElementById('templateScript');
      if (oldTemplateSctipt) head.removeChild(oldTemplateSctipt);
      iframeWindow.bridge.tmplTool.addTmpls(template);
    }
    
    if (type == 'codeIsPage') {
      iframeDocument.write(code);
    } else {
      var oldRunSctipt = iframeDocument.getElementById('runScript');
      if (oldRunSctipt) head.removeChild(oldRunSctipt);
      try {
        var codeLine = Function('return (function() {/*' + code + ' */}).toString().match(/\\/\\*([^]*)\\*\\//)[1];')();
        var runScript = tmpl.br.Tag(['script', {id: 'runScript', innerHTML: 'try { ' + codeLine + ' } catch(e) { document.body.innerHTML= e; console.error(e); }'}]);
        head.appendChild(runScript.element);
      } catch(e) {
        body.innerHTML = e;
        console.error(e);
      }
    }
  }

  var iframeDocument, iframeWindow = null;
  var clearBody = function() {
    var body = iframeDocument.body;
    while (body.firstChild) {
      body.removeChild(body.firstChild);
    }
  }
  tmplScope.reflashCode = function(item) {
    if (!iframeDocument) return;
    clearBody();
    code = data.code = item.code;
    execScript(code);
  };

  tmplScope.reflashResult = function(item) {
    if (!iframeDocument) return;
    clearBody();
    template = data.template = item.template;
    execScript(code);
  };
  ##
  <div class="ta-Rendering-Area">
    <iframe data-bridge-load="##:function(target) {
    setTimeout(function() {
      iframeWindow = tmplScope.window = target.contentWindow;

      if (target.contentDocument || target.contentWindow) {
        iframeDocument = target.contentDocument || target.contentWindow.document;
        var baseTag = tmpl.br.Tag(['base', {href: location.origin + location.pathname}]);
        iframeDocument.head.appendChild(baseTag.element);
        imports.forEach(function(obj) {
          var tag = createImportElement(obj);
          if (tag) iframeDocument.head.appendChild(tag.element);
        });
      }
    });

    }##" sandbox="allow-same-origin allow-scripts allow-modals"></iframe>
  </div>
</template>

<template id="ta-Console-Area">
  <style id="style-ta-Console-Area">
    .ta-Console-Area {
      border-top: 1px solid #ccc;
      background-color: #f7f7f7;
      height: 200px;
      clear: both;
    }
    .ta-Console-Area > .logArea {
      overflow-y: auto;
      height: calc(100% - 23px);
    }
    .ta-Console-Area > .logArea > p {
      margin: 0 0 4px;
    }
    .ta-Console-Area > .logArea > pre {
      font-size: 10px;
      border-width: 0px;
      margin: 0 0 10px;
      padding: 4px;
    }
    .ta-Console-Area > .logArea > .error {
      color: red;
    }
    .ta-Console-Area > .controlArea {
      height: 23px;
    }
    .ta-Console-Area > .controlArea .btn {
      border-radius: 0px;
      border: 1px solid #f7f7f7;
    }
    .ta-Console-Area > .controlArea .left {
      float: left;
    }
    .ta-Console-Area > .controlArea .right {
      float: right;
    }
    .ta-Console-Area > .controlArea .form-group {
      margin-bottom: 0px;
      width: calc(100% - 150px);
      display: inline-block;
      margin-left: 1px;
    }
    .ta-Console-Area > .controlArea .input-sm {
      height: 20px;
      padding: 2px 4px;
      font-size: 10px;
      line-height: 1;
      border-radius: 0px;
    }
  </style>
  ##
  var targetWindow = data.window;
  var show = !!data.show ? true : false;
  var autoScroll = data.autoScroll === false ? false : true;

  tmplScope.clear = function() {
    while (area.firstChild) { area.removeChild(area.firstChild); }
  }

  tmplScope.console = {
    log: function() {
      console.log.apply(null, arguments);
      for (var i = 0; i < arguments.length; i++) {
        var target = arguments[i];
        if (target == undefined) {
          htmlString = undefined;
        } else if (target instanceof Function) {
          htmlString = target.toString(); //.split("\n  ").join("\n");
        } else if (target.outerHTML) {
          htmlString = bridge.tmplTool.escapeHtml.escape(target.outerHTML);
        } else if (typeof target == 'object') {
          var seen = [];
          var replacer = function(key, value) {
            if (value != null && typeof value == "object") {
              if (seen.indexOf(value) >= 0) {
                return;
              }
              seen.push(value);
            }
            return value;
          };
        
          htmlString = (JSON && JSON.stringify ? JSON.stringify(target, replacer, 2) : target);
        } else {
          htmlString = target;
        }

        var ele = document.createElement('pre');
        ele.innerHTML = '> ' + (htmlString && htmlString.trim ? htmlString.trim() : htmlString);
        area.appendChild(ele);
        if (autoScroll) area.scrollTo(0, area.scrollHeight);
      }
    },
    error: function(error) {
      var ele = document.createElement('pre');
      ele.classList.add('error');
      ele.innerHTML = error.stack;
      area.appendChild(ele);
      if (autoScroll) area.scrollTo(0, area.scrollHeight);
    }
  }

  tmplScope.show = function(value) {
    tmplScope.element.style.display = value ? '' : 'none';
  }
  
  var consoleBackup = null;
  tmplScope.setWindow = function(target) {
    if (target) {
      var backup = {};
      for (var key in tmplScope.console) {
        backup[key] = target.console[key];
        target.console[key] = tmplScope.console[key];
      }
      consoleBackup = backup;
      targetWindow = target;
    }
  }

  tmplScope.setWindow(targetWindow);
  ##
  <div class="ta-Console-Area" style="##=show ? '' : 'display: none;'##">
    <div class="logArea" data-bridge-var="##:area##"></div>
    <div class="controlArea">
      ##%tmpl.bs.Field({class: '', size: 'sm', enterKeyEvent: function(e) {
        var command = e.target.value.trim();
        e.target.value = '';
        if (!command) return;
        /*
        var iframeDocument = targetWindow.document;
        var script = iframeDocument.getElementById('consoleScript');
        if (script) iframeDocument.head.removeChild(script);

        var consoleScript = tmpl.br.Tag(['script', {id: 'consoleScript', innerHTML: 'try { ' + command + ' } catch(error) { console.error(error); }'}]);
        iframeDocument.head.appendChild(consoleScript.element);
        */
        try {
          var result = targetWindow.eval(command);
        } catch(error) {
          targetWindow.console.error(error);
        }
        targetWindow.console.log(result);
        
      }})##
      ##%tmpl.bs.Button({label: 'AUTO SCROLL', styleClass: 'xs right '+ (autoScroll ? 'btn-success' : ''), event: function(e, edata, tmplElem) {
        autoScroll = !autoScroll;
        tmplElem.classList[autoScroll ? 'add' : 'remove']('btn-success');
      }})##
      ##%tmpl.bs.Button({label: 'CLEAR', styleClass: 'xs right', event: function() {
        tmplScope.clear();
      }})##
    </div>
  </div>
</template>

</body>